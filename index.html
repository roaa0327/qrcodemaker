<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR 코드 생성기 - Windows XP Style</title>
    <style>
        /* CSS 스타일 - Windows XP Style */
        body {
            font-family: 'Tahoma', sans-serif; /* XP 기본 폰트 */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(to bottom, #3a6ea5 0%, #4a8ed4 100%); /* XP 배경색 */
            margin: 0;
            overflow: hidden; /* 스크롤바 방지 */
            cursor: url('data:image/x-icon;base64,AAACAAEAICAAAAAAAADoAgAAFgAAACgAAAAgAAAAQAAAAAEAAQAAAAAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPAAAAAAAAAAAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAD//wAAAAAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAA//8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP//AAAAAAAAAAAAAP8AAAAAAAAAAAD//wAAAAAAAAAAAAAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP//AAAAAAAAAAAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP//AAAAAAAAAAAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP//AAAAAAAAAAAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP//AAAAAAAAAAAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP//AAAAAAAAAAAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP//AAAAAAAAAAAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP//AAAAAAAAAAAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP//AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=') 0 0, auto; /* XP 기본 커서 */
            position: relative; /* 자식 창들의 위치 기준 */
        }

        /* 새로운 창 띄우기 버튼 스타일 (데스크톱 아이콘처럼) */
        #new-window-button {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 8px 12px;
            background: linear-gradient(to bottom, #f2f7fb 0%, #d4e7f8 100%);
            border: 1px solid #0A246A;
            border-radius: 4px;
            box-shadow: 2px 2px 0 #808080, inset 1px 1px 0 #ffffff;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1000; /* 항상 맨 위에 */
            text-align: center;
            user-select: none;
            width: 120px;
            line-height: 1.2;
        }
        #new-window-button:active {
            box-shadow: inset 1px 1px 0 #808080, 1px 1px 0 #fff;
            background: linear-gradient(to bottom, #d4e7f8 0%, #f2f7fb 100%);
        }

        .window {
            background-color: #ECE9D8; /* XP 윈도우 배경색 */
            border: 1px solid #0A246A; /* XP 윈도우 테두리 */
            box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.4); /* XP 윈도우 그림자 */
            width: 100%;
            max-width: 450px; /* 창 크기 조절 */
            border-radius: 2px;
            display: flex;
            flex-direction: column;
            position: absolute; /* 드래그를 위한 절대 위치 */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            resize: both;
            overflow: auto;
            min-width: 300px;
            min-height: 350px;
            z-index: 10;
        }

        .title-bar {
            background: linear-gradient(to right, #005DC9 0%, #0080FF 100%); /* XP 제목 표시줄 그라데이션 */
            color: white;
            padding: 4px 8px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #0A246A;
            cursor: grab; /* 드래그 가능 커서 */
            user-select: none;
        }

        /* 나머지 스타일은 이전과 동일하게 유지 */
        .title-bar-text { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .title-bar-controls { display: flex; gap: 2px; }
        .title-bar-button { width: 18px; height: 18px; background-color: #C0C0C0; border: 1px solid #fff; box-shadow: 1px 1px 0 #808080, inset 1px 1px 0 #dfdfdf; display: flex; justify-content: center; align-items: center; font-size: 14px; font-weight: bold; cursor: pointer; color: #000; user-select: none; }
        .title-bar-button:active { box-shadow: inset 1px 1px 0 #808080, 1px 1px 0 #fff; background-color: #808080; }
        .content { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; gap: 10px; align-items: center; }
        .input-group { width: 100%; display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; }
        label { font-size: 12px; color: #333; text-align: left; width: 100%; }
        input[type="text"], select { width: calc(100% - 10px); padding: 4px; border: 1px solid #7F9DB9; background-color: #fff; font-size: 13px; box-shadow: inset 1px 1px 0 #E0E0E0; font-family: 'Tahoma', sans-serif; }
        input[type="text"]:focus, select:focus { outline: none; border: 1px solid #000080; }
        .xp-button { background: linear-gradient(to bottom, #d9e9f8 0%, #a9d2f6 100%); border: 1px solid #0A246A; padding: 6px 15px; font-size: 13px; cursor: pointer; color: #000; font-family: 'Tahoma', sans-serif; text-shadow: 1px 1px 0 rgba(255,255,255,0.7); box-shadow: 1px 1px 0 #fff, inset 1px 1px 0 #fff; margin-top: 10px; min-width: 100px; }
        .xp-button:hover { background: linear-gradient(to bottom, #e9f5fd 0%, #b2dbfb 100%); }
        .xp-button:active { background: linear-gradient(to bottom, #a9d2f6 0%, #d9e9f8 100%); box-shadow: inset 1px 1px 0 #0A246A, 1px 1px 0 #fff; }
        #qr-code { margin-top: 20px; border: 1px solid #7F9DB9; background-color: #fff; padding: 5px; display: inline-block; box-shadow: inset 1px 1px 0 #E0E0E0; min-width: 200px; min-height: 200px; display: flex; justify-content: center; align-items: center; }
        #qr-code img { max-width: 100%; height: auto; display: block; }
        .error { color: red; margin-top: 10px; font-weight: bold; font-size: 12px; }
        .file-controls { display: flex; gap: 10px; margin-top: 15px; width: 100%; justify-content: center; }
        .file-controls .xp-button { width: auto; min-width: 80px; }
        .moving { cursor: grabbing !important; }
        .focused { z-index: 50; /* 가장 앞에 있는 창 */ }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
    <div id="new-window-button" onclick="createNewWindow()">[새로운 창 띄우기]</div>

    <div class="window focused" id="qrWindow_1" style="left: 50%; top: 50%; transform: translate(-50%, -50%);" data-window-id="1">
        <div class="title-bar" id="titleBar_1">
            <span class="title-bar-text">✨ QR Code Generator #1</span>
            <div class="title-bar-controls">
                <div class="title-bar-button minimize" onclick="minimizeWindow('qrWindow_1')">_</div>
                <div class="title-bar-button maximize" onclick="maximizeWindow('qrWindow_1')">&#9633;</div>
                <div class="title-bar-button close" onclick="closeWindow('qrWindow_1')">X</div>
            </div>
        </div>

        <div class="content">
            <div class="input-group">
                <label for="qr-text_1">QR 코드로 만들 내용:</label>
                <input type="text" id="qr-text_1" placeholder="텍스트 또는 URL을 입력하세요." value="https://www.google.com">
            </div>

            <div class="input-group">
                <label for="qr-size_1">QR 코드 크기:</label>
                <select id="qr-size_1">
                    <option value="128">작게 (128x128)</option>
                    <option value="200" selected>보통 (200x200)</option>
                    <option value="300">크게 (300x300)</option>
                    <option value="400">아주 크게 (400x400)</option>
                </select>
            </div>

            <button class="xp-button" onclick="generateQRCode('1')">QR 코드 생성</button>

            <div id="qr-code_1">
                </div>
            <p class="error" id="error-message_1"></p>

            <div class="file-controls">
                <button class="xp-button" onclick="downloadQRCode('1', 'png')">PNG로 저장</button>
                <button class="xp-button" onclick="downloadQRCode('1', 'jpeg')">JPEG로 저장</button>
            </div>
        </div>
    </div>

    <script>
        // 전역 상태 관리
        let windowIdCounter = 1; // 창 ID 카운터
        const maxWindows = 5; // 최대 창 개수 제한

        // 각 창의 QR 코드 인스턴스를 저장하는 맵
        const qrcodeInstances = new Map();
        // 각 창의 Data URL을 저장하는 맵
        const dataURLMap = new Map();

        // --------------------------------------------------
        // ## 1. QR 코드 생성 및 다운로드 기능 (멀티 창 지원)
        // --------------------------------------------------

        function generateQRCode(id) {
            const qrCodeContainer = document.getElementById(`qr-code_${id}`);
            const qrText = document.getElementById(`qr-text_${id}`);
            const qrSize = document.getElementById(`qr-size_${id}`);
            const errorMessage = document.getElementById(`error-message_${id}`);

            const text = qrText.value.trim();
            const size = parseInt(qrSize.value);
            errorMessage.textContent = '';

            if (!text) {
                errorMessage.textContent = '❌ 내용을 입력해주세요.';
                qrCodeContainer.innerHTML = '';
                qrcodeInstances.delete(id);
                dataURLMap.delete(id);
                return;
            }

            // 기존 QR 코드 삭제
            qrCodeContainer.innerHTML = '';

            // QRCode 인스턴스 생성 및 QR 코드 그리기
            const qrcode = new QRCode(qrCodeContainer, {
                text: text,
                width: size,
                height: size,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
            qrcodeInstances.set(id, qrcode);

            // QR 코드 생성 후 Data URL 가져오기
            // qrcode.js는 비동기적으로 이미지를 그리므로 약간의 지연이 필요
            setTimeout(() => {
                const img = qrCodeContainer.querySelector('img');
                const canvas = qrCodeContainer.querySelector('canvas');
                let dataURL = null;

                if (img) {
                    dataURL = img.src;
                } else if (canvas) {
                    dataURL = canvas.toDataURL();
                }
                dataURLMap.set(id, dataURL);
            }, 100);
        }

        function downloadQRCode(id, format) {
            const currentQRCodeDataURL = dataURLMap.get(id);
            const errorMessage = document.getElementById(`error-message_${id}`);

            if (!currentQRCodeDataURL) {
                errorMessage.textContent = '❌ 먼저 QR 코드를 생성해주세요!';
                return;
            }

            const link = document.createElement('a');
            link.href = currentQRCodeDataURL;
            link.download = `qrcode_winxp_${id}_${Date.now()}.${format}`;

            if (format === 'jpeg' && currentQRCodeDataURL.startsWith('data:image/png')) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');

                    // JPEG는 투명도를 지원하지 않으므로 배경을 흰색으로 채움
                    ctx.fillStyle = "#FFFFFF";
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);

                    link.href = canvas.toDataURL('image/jpeg');
                    link.click();
                };
                img.src = currentQRCodeDataURL;
            } else {
                link.click();
            }
        }

        // --------------------------------------------------
        // ## 2. 창 제어 및 드래그 기능 (XP 스타일)
        // --------------------------------------------------

        // 모든 창의 Z-Index를 관리하여 클릭된 창이 앞으로 나오도록 함
        function focusWindow(windowElement) {
            document.querySelectorAll('.window').forEach(win => {
                win.classList.remove('focused');
                win.style.zIndex = 10;
            });
            windowElement.classList.add('focused');
            windowElement.style.zIndex = 50;
        }

        // 창 드래그 기능 설정
        function setupWindowDrag(windowElement) {
            const titleBar = windowElement.querySelector('.title-bar');
            let isDragging = false;
            let offset = { x: 0, y: 0 };

            // 창 클릭 시 포커스
            windowElement.addEventListener('mousedown', (e) => {
                focusWindow(windowElement);
            });

            titleBar.addEventListener('mousedown', (e) => {
                // 버튼 영역이 아닌 경우에만 드래그 시작
                if (!e.target.classList.contains('title-bar-button')) {
                    isDragging = true;
                    windowElement.classList.add('moving');
                    offset = {
                        x: e.clientX - windowElement.getBoundingClientRect().left,
                        y: e.clientY - windowElement.getBoundingClientRect().top
                    };
                    focusWindow(windowElement); // 드래그 시작 시 포커스
                }
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                // 창의 위치를 body 기준으로 설정
                const newLeft = e.clientX - offset.x;
                const newTop = e.clientY - offset.y;

                // 화면 밖으로 나가지 않도록 경계 설정 (간단하게 구현)
                const maxX = window.innerWidth - windowElement.offsetWidth;
                const maxY = window.innerHeight - windowElement.offsetHeight;

                windowElement.style.left = Math.max(0, Math.min(newLeft, maxX)) + 'px';
                windowElement.style.top = Math.max(0, Math.min(newTop, maxY)) + 'px';
                windowElement.style.transform = 'none'; // 드래그 중에는 transform 제거
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
                windowElement.classList.remove('moving');
            });
        }

        // 윈도우 컨트롤 (XP 스타일 흉내)
        function minimizeWindow(id) {
            const win = document.getElementById(id);
            if(win) win.style.display = 'none';
            alert(`"${id}" 창을 최소화합니다. (실제 기능 미구현)`);
        }

        function maximizeWindow(id) {
            const win = document.getElementById(id);
            if (!win) return;
            
            if (win.style.width === '90vw') {
                // 복원
                win.style.width = '450px';
                win.style.height = 'auto';
                win.style.left = win.getAttribute('data-last-left') || '50%';
                win.style.top = win.getAttribute('data-last-top') || '50%';
                win.style.transform = win.getAttribute('data-last-transform') || 'translate(-50%, -50%)';
                win.removeAttribute('data-maximized');
            } else {
                // 현재 위치 저장
                win.setAttribute('data-last-left', win.style.left);
                win.setAttribute('data-last-top', win.style.top);
                win.setAttribute('data-last-transform', win.style.transform);

                // 최대화
                win.style.width = '90vw';
                win.style.height = '90vh';
                win.style.left = '5vw';
                win.style.top = '5vh';
                win.style.transform = 'none';
                win.setAttribute('data-maximized', 'true');
            }
        }

        function closeWindow(id) {
            if (confirm(`"${id}" 창을 닫으시겠습니까?`)) {
                const win = document.getElementById(id);
                if(win) win.remove();
            }
        }

        // --------------------------------------------------
        // ## 3. 새로운 창 띄우기 기능
        // --------------------------------------------------

        function createNewWindow() {
            const existingWindows = document.querySelectorAll('.window').length;
            if (existingWindows >= maxWindows) {
                alert(`최대 ${maxWindows}개의 QR 코드 생성기 창만 띄울 수 있습니다.`);
                return;
            }

            windowIdCounter++;
            const newId = windowIdCounter;
            const newWindowId = `qrWindow_${newId}`;

            // 새로운 창의 HTML 구조 생성
            const newWindowHTML = `
                <div class="window" id="${newWindowId}" data-window-id="${newId}" style="left: calc(50% + ${newId * 10}px); top: calc(50% + ${newId * 10}px); transform: translate(-50%, -50%);">
                    <div class="title-bar" id="titleBar_${newId}">
                        <span class="title-bar-text">✨ QR Code Generator #${newId}</span>
                        <div class="title-bar-controls">
                            <div class="title-bar-button minimize" onclick="minimizeWindow('${newWindowId}')">_</div>
                            <div class="title-bar-button maximize" onclick="maximizeWindow('${newWindowId}')">&#9633;</div>
                            <div class="title-bar-button close" onclick="closeWindow('${newWindowId}')">X</div>
                        </div>
                    </div>

                    <div class="content">
                        <div class="input-group">
                            <label for="qr-text_${newId}">QR 코드로 만들 내용:</label>
                            <input type="text" id="qr-text_${newId}" placeholder="텍스트 또는 URL을 입력하세요." value="새로운 창 ${newId} 입니다.">
                        </div>

                        <div class="input-group">
                            <label for="qr-size_${newId}">QR 코드 크기:</label>
                            <select id="qr-size_${newId}">
                                <option value="128">작게 (128x128)</option>
                                <option value="200" selected>보통 (200x200)</option>
                                <option value="300">크게 (300x300)</option>
                                <option value="400">아주 크게 (400x400)</option>
                            </select>
                        </div>

                        <button class="xp-button" onclick="generateQRCode('${newId}')">QR 코드 생성</button>

                        <div id="qr-code_${newId}">
                        </div>
                        <p class="error" id="error-message_${newId}"></p>

                        <div class="file-controls">
                            <button class="xp-button" onclick="downloadQRCode('${newId}', 'png')">PNG로 저장</button>
                            <button class="xp-button" onclick="downloadQRCode('${newId}', 'jpeg')">JPEG로 저장</button>
                        </div>
                    </div>
                </div>
            `;
            
            // body에 새로운 창 추가
            document.body.insertAdjacentHTML('beforeend', newWindowHTML);

            // 새로 생성된 창에 드래그 기능 적용 및 포커스
            const newWindowElement = document.getElementById(newWindowId);
            setupWindowDrag(newWindowElement);
            focusWindow(newWindowElement);

            // 새로 생성된 창의 초기 QR 코드 생성
            generateQRCode(newId);
        }

        // 초기 설정: 첫 번째 창에 드래그 기능 적용 및 초기 QR 코드 생성
        window.onload = function() {
            setupWindowDrag(document.getElementById('qrWindow_1'));
            generateQRCode('1');
        };
    </script>
</body>
</html>